{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/CS%20Y3/FYP/FWMS/FWMS/app/api/farmer/requests/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\n\n/**\n * Request body for creating a farmer pickup request.\n */\ntype CreateRequestBody = {\n  wasteId: string\n  requesterId: string\n  preferredTime?: string\n  notes?: string\n}\n\n/**\n * GET /api/farmer/requests\n * Returns all pickup requests for the current farmer user.\n * \n * For approved requests, includes café contact information:\n * - Waste item name and quantity\n * - Café name, phone, email, address\n * - Message: \"Please contact the café to arrange pickup.\"\n */\nexport async function GET(req: NextRequest) {\n  try {\n    // Get user ID from request header\n    const userId = req.headers.get(\"x-user-id\")\n    if (!userId) {\n      return NextResponse.json([])\n    }\n\n    const { db } = await import(\"@/lib/db\")\n\n    // Verify user is a farmer (PARTNER role with FARM business type)\n    const user = await db.user.findUnique({\n      where: { id: userId },\n      include: { business: true },\n    })\n\n    if (!user || user.role !== \"PARTNER\" || user.business?.type !== \"FARM\") {\n      return NextResponse.json([])\n    }\n\n    // Fetch all pickup requests for this farmer\n    // Exclude cancelled requests, but include completed ones for history\n    const pickupRequests = await db.pickupRequest.findMany({\n      where: {\n        requesterId: userId,\n        status: {\n          notIn: [\"CANCELLED\"],\n        },\n      },\n      include: {\n        wasteEntry: {\n          include: {\n            business: true,\n          },\n        },\n        business: true, // Café information\n      },\n      orderBy: {\n        requestedDate: \"desc\", // Most recent first\n      },\n    })\n\n    // Transform database format to frontend format\n    const items = pickupRequests.map((request) => {\n      const waste = request.wasteEntry\n      const cafe = request.business\n\n      return {\n        id: request.id,\n        wasteId: request.wasteEntryId,\n        requesterId: request.requesterId,\n        requesterType: \"farmer\",\n        status: request.status.toLowerCase(),\n        requestedAt: request.requestedDate.toISOString(),\n        approvedAt: request.approvedAt?.toISOString(),\n        completedAt: request.completedAt?.toISOString(),\n        notes: request.notes,\n        // Waste item information\n        itemName: waste?.subType || \"Unknown\",\n        quantity: waste?.quantity || 0,\n        // Café information (only for approved requests)\n        cafeName: cafe?.name || \"Unknown Café\",\n        cafeId: cafe?.id,\n        cafe: request.status === \"APPROVED\" && cafe ? {\n          name: cafe.name,\n          phone: cafe.phone,\n          email: cafe.email,\n          address: cafe.address,\n          contactPerson: cafe.contactPerson,\n        } : null,\n        cafeContact: request.status === \"APPROVED\" && cafe ? {\n          name: cafe.contactPerson || cafe.name,\n          email: cafe.email,\n          phone: cafe.phone,\n          address: cafe.address,\n        } : null,\n        message: request.status === \"APPROVED\" ? \"Please contact the café to arrange pickup.\" : undefined,\n      }\n    })\n\n    console.log(`[Farmer Requests] Returning ${items.length} requests`)\n    return NextResponse.json(items)\n  } catch (error) {\n    console.error(\"[Farmer Requests] Error:\", error)\n    return NextResponse.json([])\n  }\n}\n\n/**\n * POST /api/farmer/requests\n * Creates a new pickup request for a farmer user.\n * \n * When a farmer clicks \"Request Collection\" on a waste item:\n * 1. Validates the farmer user\n * 2. Checks if waste item is available\n * 3. Creates a pickup request linked to waste entry, requester, and café\n */\nexport async function POST(req: NextRequest) {\n  try {\n    const body = (await req.json()) as Partial<CreateRequestBody>\n    if (!body.wasteId || !body.requesterId) {\n      return NextResponse.json({ error: \"Missing wasteId or requesterId\" }, { status: 400 })\n    }\n\n    const { db } = await import(\"@/lib/db\")\n\n    // Verify requester is a valid farmer user\n    const requester = await db.user.findUnique({\n      where: { id: body.requesterId },\n      include: { business: true },\n    })\n\n    if (!requester) {\n      return NextResponse.json({ error: \"Invalid requesterId\" }, { status: 400 })\n    }\n    if (requester.role !== \"PARTNER\" || requester.business?.type !== \"FARM\") {\n      return NextResponse.json({ error: \"Requester must be a farmer user\" }, { status: 403 })\n    }\n\n    // Find the waste entry\n    const wasteEntry = await db.wasteEntry.findUnique({\n      where: { id: body.wasteId },\n      include: { business: true },\n    })\n\n    if (!wasteEntry) {\n      return NextResponse.json({ error: \"Waste item not found\" }, { status: 404 })\n    }\n\n    // Check if waste is available for farmer pickup\n    if (wasteEntry.status !== \"PENDING\" || wasteEntry.availableFor !== \"FARMER\") {\n      return NextResponse.json({ error: \"Waste item is not available for farm pickup\" }, { status: 400 })\n    }\n\n    // Prevent duplicate requests for the same waste item\n    const existingRequest = await db.pickupRequest.findUnique({\n      where: { wasteEntryId: body.wasteId },\n    })\n\n    if (existingRequest) {\n      return NextResponse.json({ error: \"This waste item already has a pickup request\" }, { status: 400 })\n    }\n\n    // Create the pickup request\n    const pickupRequest = await db.pickupRequest.create({\n      data: {\n        requesterId: requester.id,\n        wasteEntryId: body.wasteId,\n        businessId: wasteEntry.businessId, // Café that owns the waste\n        notes: body.notes || null,\n        status: \"PENDING\", // Admin will approve later\n      },\n      include: {\n        requester: {\n          select: {\n            id: true,\n            name: true,\n            email: true,\n          },\n        },\n        business: {\n          select: {\n            id: true,\n            name: true,\n            type: true,\n            address: true,\n          },\n        },\n        wasteEntry: {\n          select: {\n            id: true,\n            subType: true,\n            quantity: true,\n            status: true,\n          },\n        },\n      },\n    })\n\n    console.log(`[Farmer Request] ✅ Created pickup request:`, {\n      id: pickupRequest.id,\n      wasteEntryId: body.wasteId,\n      requesterId: requester.id,\n      businessId: wasteEntry.businessId,\n    })\n\n    return NextResponse.json(pickupRequest, { status: 201 })\n  } catch (error) {\n    console.error(\"[Farmer Request] Error:\", error)\n    return NextResponse.json(\n      { error: \"Failed to create pickup request\", message: error instanceof Error ? error.message : String(error) },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}
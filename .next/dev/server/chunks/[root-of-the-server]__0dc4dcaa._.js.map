{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/CS%20Y3/FYP/FWMS/FWMS/app/api/charity/requests/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\n\n/**\n * Request body for creating a charity pickup request.\n * Supports both new format (charityId, itemId) and legacy format (requesterId, wasteId).\n */\ntype CreateRequestBody = {\n  // New format\n  charityId?: string\n  itemId?: string\n  cafeId?: string\n  status?: string\n  note?: string\n  // Legacy format (for backward compatibility)\n  wasteId?: string\n  requesterId?: string\n  preferredTime?: string\n  notes?: string\n}\n\n/**\n * GET /api/charity/requests\n * Returns all pickup requests for the current charity user.\n * \n * For approved requests, includes café contact information:\n * - Waste item name and quantity\n * - Café name, phone, email, address\n * - Message: \"Please contact the café to arrange pickup.\"\n */\nexport async function GET(req: NextRequest) {\n  try {\n    // Get user ID from request header\n    const userId = req.headers.get(\"x-user-id\")\n    if (!userId) {\n      return NextResponse.json({ error: \"Missing user ID\" }, { status: 400 })\n    }\n\n    const { db } = await import(\"@/lib/db\")\n\n    // Verify user is a charity (PARTNER role with NGO business type)\n    const user = await db.user.findUnique({\n      where: { id: userId },\n      include: { business: true },\n    })\n\n    if (!user || user.role !== \"PARTNER\" || user.business?.type !== \"NGO\") {\n      return NextResponse.json({ error: \"Invalid charity user\" }, { status: 400 })\n    }\n\n    // Fetch all pickup requests for this charity\n    // Exclude cancelled requests, but include completed ones for history\n    const pickupRequests = await db.pickupRequest.findMany({\n      where: {\n        requesterId: userId,\n        status: {\n          notIn: [\"CANCELLED\"],\n        },\n      },\n      include: {\n        wasteEntry: {\n          include: {\n            business: true,\n          },\n        },\n        business: true, // Café information\n      },\n      orderBy: {\n        requestedDate: \"desc\", // Most recent first\n      },\n    })\n\n    // Transform database format to frontend format\n    const items = pickupRequests.map((request) => {\n      const waste = request.wasteEntry\n      const cafe = request.business\n\n      return {\n        id: request.id,\n        wasteId: request.wasteEntryId,\n        requesterId: request.requesterId,\n        requesterType: \"charity\",\n        status: request.status.toLowerCase(),\n        requestedAt: request.requestedDate.toISOString(),\n        approvedAt: request.approvedAt?.toISOString(),\n        completedAt: request.completedAt?.toISOString(),\n        notes: request.notes,\n        // Waste item information\n        itemName: waste?.subType || \"Unknown\",\n        quantity: waste?.quantity || 0,\n        // Café information (only for approved requests)\n        cafeName: cafe?.name || \"Unknown Café\",\n        cafeId: cafe?.id,\n        cafe: request.status === \"APPROVED\" && cafe ? {\n          name: cafe.name,\n          phone: cafe.phone,\n          email: cafe.email,\n          address: cafe.address,\n          contactPerson: cafe.contactPerson,\n        } : null,\n        message: request.status === \"APPROVED\" ? \"Please contact the café to arrange pickup.\" : undefined,\n      }\n    })\n\n    console.log(`[Charity Requests] Returning ${items.length} requests`)\n    return NextResponse.json(items)\n  } catch (error) {\n    console.error(\"[Charity Requests] Error:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch requests\", message: error instanceof Error ? error.message : String(error) },\n      { status: 500 }\n    )\n  }\n}\n\n/**\n * POST /api/charity/requests\n * Creates a new pickup request for a charity user.\n * \n * When a charity clicks \"Request Pickup\" on a waste item:\n * 1. Validates the charity user\n * 2. Checks if waste item is available\n * 3. Creates a pickup request linked to waste entry, requester, and café\n */\nexport async function POST(req: NextRequest) {\n  try {\n    const body = (await req.json()) as Partial<CreateRequestBody>\n    \n    // Support both new and legacy request formats\n    const charityId = body.charityId || body.requesterId\n    const itemId = body.itemId || body.wasteId\n    \n    if (!itemId || !charityId) {\n      return NextResponse.json({ error: \"Missing itemId/wasteId or charityId/requesterId\" }, { status: 400 })\n    }\n\n    const { db } = await import(\"@/lib/db\")\n\n    // Verify requester is a valid charity user\n    const requester = await db.user.findUnique({\n      where: { id: charityId },\n      include: { business: true },\n    })\n\n    if (!requester) {\n      return NextResponse.json({ error: \"Invalid charityId/requesterId\" }, { status: 400 })\n    }\n    if (requester.role !== \"PARTNER\" || requester.business?.type !== \"NGO\") {\n      return NextResponse.json({ error: \"Requester must be a charity user\" }, { status: 403 })\n    }\n\n    // Find the waste entry\n    const wasteEntry = await db.wasteEntry.findUnique({\n      where: { id: itemId },\n      include: { business: true },\n    })\n\n    if (!wasteEntry) {\n      return NextResponse.json({ error: \"Waste item not found\" }, { status: 404 })\n    }\n\n    // Check if waste is available for charity pickup\n    if (wasteEntry.status !== \"PENDING\" || wasteEntry.availableFor !== \"CHARITY\") {\n      return NextResponse.json({ error: \"Waste item is not available for charity\" }, { status: 400 })\n    }\n\n    // Prevent duplicate requests for the same waste item\n    const existingRequest = await db.pickupRequest.findUnique({\n      where: { wasteEntryId: itemId },\n    })\n\n    if (existingRequest) {\n      return NextResponse.json({ error: \"This waste item already has a pickup request\" }, { status: 400 })\n    }\n\n    // Create the pickup request\n    const pickupRequest = await db.pickupRequest.create({\n      data: {\n        requesterId: requester.id,\n        wasteEntryId: itemId,\n        businessId: wasteEntry.businessId, // Café that owns the waste\n        notes: body.note || body.notes || null,\n        status: \"PENDING\", // Admin will approve later\n      },\n      include: {\n        requester: {\n          select: {\n            id: true,\n            name: true,\n            email: true,\n          },\n        },\n        business: {\n          select: {\n            id: true,\n            name: true,\n            type: true,\n            address: true,\n          },\n        },\n        wasteEntry: {\n          select: {\n            id: true,\n            subType: true,\n            quantity: true,\n            status: true,\n          },\n        },\n      },\n    })\n\n    console.log(`[Charity Request] ✅ Created pickup request:`, {\n      id: pickupRequest.id,\n      wasteEntryId: itemId,\n      requesterId: requester.id,\n      businessId: wasteEntry.businessId,\n    })\n\n    return NextResponse.json(pickupRequest, { status: 201 })\n  } catch (error) {\n    console.error(\"[Charity Request] Error:\", error)\n    return NextResponse.json(\n      { error: \"Failed to create pickup request\", message: error instanceof Error ? error.message : String(error) },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}
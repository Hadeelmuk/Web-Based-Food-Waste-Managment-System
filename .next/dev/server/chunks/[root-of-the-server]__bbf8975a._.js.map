{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///D:/CS%20Y3/FYP/FWMS/FWMS/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma: PrismaClient | undefined\r\n}\r\n\r\nexport const db =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\r\n  })\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = db\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///D:/CS%20Y3/FYP/FWMS/FWMS/lib/auth.ts"],"sourcesContent":["import { NextAuthOptions } from \"next-auth\"\r\nimport CredentialsProvider from \"next-auth/providers/credentials\"\r\nimport { db } from \"./db\"\r\nimport bcrypt from \"bcryptjs\"\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: \"Credentials\",\r\n      credentials: {\r\n        email: { label: \"Email\", type: \"email\" },\r\n        password: { label: \"Password\", type: \"password\" },\r\n      },\r\n      async authorize(credentials) {\r\n        if (!credentials?.email || !credentials?.password) {\r\n          return null\r\n        }\r\n\r\n        const user = await db.user.findUnique({\r\n          where: {\r\n            email: credentials.email,\r\n          },\r\n          include: {\r\n            business: true,\r\n          },\r\n        })\r\n\r\n        if (!user) {\r\n          return null\r\n        }\r\n\r\n        const isPasswordValid = await bcrypt.compare(credentials.password, user.password)\r\n\r\n        if (!isPasswordValid) {\r\n          return null\r\n        }\r\n\r\n        return {\r\n          id: user.id,\r\n          email: user.email,\r\n          name: user.name,\r\n          role: user.role,\r\n          businessId: user.businessId,\r\n          business: user.business,\r\n        }\r\n      },\r\n    }),\r\n  ],\r\n  session: {\r\n    strategy: \"jwt\",\r\n  },\r\n  pages: {\r\n    signIn: \"/login\",\r\n    signOut: \"/\",\r\n  },\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.id = user.id\r\n        token.role = user.role\r\n        token.businessId = user.businessId\r\n        token.business = user.business\r\n      }\r\n      return token\r\n    },\r\n    async session({ session, token }) {\r\n      if (session.user) {\r\n        session.user.id = token.id as string\r\n        session.user.role = token.role as string\r\n        session.user.businessId = token.businessId as string | null\r\n        session.user.business = token.business as any\r\n      }\r\n      return session\r\n    },\r\n  },\r\n  secret: process.env.NEXTAUTH_SECRET,\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AACA;AACA;AACA;;;;AAEO,MAAM,cAA+B;IAC1C,WAAW;QACT,IAAA,6KAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU;oBACjD,OAAO;gBACT;gBAEA,MAAM,OAAO,MAAM,yHAAE,CAAC,IAAI,CAAC,UAAU,CAAC;oBACpC,OAAO;wBACL,OAAO,YAAY,KAAK;oBAC1B;oBACA,SAAS;wBACP,UAAU;oBACZ;gBACF;gBAEA,IAAI,CAAC,MAAM;oBACT,OAAO;gBACT;gBAEA,MAAM,kBAAkB,MAAM,sJAAM,CAAC,OAAO,CAAC,YAAY,QAAQ,EAAE,KAAK,QAAQ;gBAEhF,IAAI,CAAC,iBAAiB;oBACpB,OAAO;gBACT;gBAEA,OAAO;oBACL,IAAI,KAAK,EAAE;oBACX,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI;oBACf,MAAM,KAAK,IAAI;oBACf,YAAY,KAAK,UAAU;oBAC3B,UAAU,KAAK,QAAQ;gBACzB;YACF;QACF;KACD;IACD,SAAS;QACP,UAAU;IACZ;IACA,OAAO;QACL,QAAQ;QACR,SAAS;IACX;IACA,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;gBAClB,MAAM,IAAI,GAAG,KAAK,IAAI;gBACtB,MAAM,UAAU,GAAG,KAAK,UAAU;gBAClC,MAAM,QAAQ,GAAG,KAAK,QAAQ;YAChC;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;gBAC1B,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;gBAC9B,QAAQ,IAAI,CAAC,UAAU,GAAG,MAAM,UAAU;gBAC1C,QAAQ,IAAI,CAAC,QAAQ,GAAG,MAAM,QAAQ;YACxC;YACA,OAAO;QACT;IACF;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC","debugId":null}},
    {"offset": {"line": 218, "column": 0}, "map": {"version":3,"sources":["file:///D:/CS%20Y3/FYP/FWMS/FWMS/app/api/reports/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { db } from \"@/lib/db\"\r\n\r\n// GET - Get analytics and reports\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n\r\n    if (!session?.user) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url)\r\n    const reportType = searchParams.get(\"type\") || \"summary\"\r\n    const startDate = searchParams.get(\"startDate\")\r\n    const endDate = searchParams.get(\"endDate\")\r\n    const businessId = searchParams.get(\"businessId\")\r\n\r\n    // Build filter object\r\n    const filter: any = {}\r\n\r\n    // Filter by business\r\n    if (session.user.role !== \"ADMIN\") {\r\n      filter.businessId = session.user.businessId\r\n    } else if (businessId) {\r\n      filter.businessId = businessId\r\n    }\r\n\r\n    // Filter by date range\r\n    if (startDate || endDate) {\r\n      filter.date = {}\r\n      if (startDate) {\r\n        filter.date.gte = new Date(startDate)\r\n      }\r\n      if (endDate) {\r\n        filter.date.lte = new Date(endDate)\r\n      }\r\n    }\r\n\r\n    if (reportType === \"summary\") {\r\n      // Get all waste entries for calculations\r\n      const allEntries = await db.wasteEntry.findMany({\r\n        where: filter,\r\n      })\r\n\r\n      // Calculate totals\r\n      let totalWaste = 0\r\n      let totalDonated = 0\r\n      let totalComposted = 0\r\n      let totalDropped = 0\r\n\r\n      for (const entry of allEntries) {\r\n        totalWaste += entry.quantity\r\n        if (entry.actionType === \"DONATE\") {\r\n          totalDonated += entry.quantity\r\n        }\r\n        if (entry.actionType === \"COMPOST\" || entry.actionType === \"FARM\") {\r\n          totalComposted += entry.quantity\r\n        }\r\n        if (entry.actionType === \"DROPPED\") {\r\n          totalDropped += entry.quantity\r\n        }\r\n      }\r\n\r\n      // Group by waste type\r\n      const wasteByType: any = {}\r\n      for (const entry of allEntries) {\r\n        if (!wasteByType[entry.wasteType]) {\r\n          wasteByType[entry.wasteType] = { quantity: 0, count: 0 }\r\n        }\r\n        wasteByType[entry.wasteType].quantity += entry.quantity\r\n        wasteByType[entry.wasteType].count += 1\r\n      }\r\n\r\n      // Group by action type\r\n      const wasteByAction: any = {}\r\n      for (const entry of allEntries) {\r\n        if (!wasteByAction[entry.actionType]) {\r\n          wasteByAction[entry.actionType] = { quantity: 0, count: 0 }\r\n        }\r\n        wasteByAction[entry.actionType].quantity += entry.quantity\r\n        wasteByAction[entry.actionType].count += 1\r\n      }\r\n\r\n      return NextResponse.json({\r\n        summary: {\r\n          totalWaste,\r\n          totalDonated,\r\n          totalComposted,\r\n          totalDropped,\r\n        },\r\n        wasteByType,\r\n        wasteByAction,\r\n      })\r\n    }\r\n\r\n    if (reportType === \"admin\") {\r\n      // Only admin can access this\r\n      if (session.user.role !== \"ADMIN\") {\r\n        return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n      }\r\n\r\n      // Get all data\r\n      const totalUsers = await db.user.count()\r\n      const totalBusinesses = await db.business.count()\r\n\r\n      const allWasteEntries = await db.wasteEntry.findMany()\r\n      let totalWaste = 0\r\n      let totalDonations = 0\r\n\r\n      for (const entry of allWasteEntries) {\r\n        totalWaste += entry.quantity\r\n        if (entry.actionType === \"DONATE\") {\r\n          totalDonations += entry.quantity\r\n        }\r\n      }\r\n\r\n      // Count businesses by type\r\n      const allBusinesses = await db.business.findMany()\r\n      const businessesByType: any = {}\r\n      for (const business of allBusinesses) {\r\n        if (!businessesByType[business.type]) {\r\n          businessesByType[business.type] = 0\r\n        }\r\n        businessesByType[business.type] += 1\r\n      }\r\n\r\n      // Get top businesses by waste quantity\r\n      const wasteByBusiness: any = {}\r\n      for (const entry of allWasteEntries) {\r\n        if (!wasteByBusiness[entry.businessId]) {\r\n          wasteByBusiness[entry.businessId] = { quantity: 0, count: 0 }\r\n        }\r\n        wasteByBusiness[entry.businessId].quantity += entry.quantity\r\n        wasteByBusiness[entry.businessId].count += 1\r\n      }\r\n\r\n      // Sort and get top 10\r\n      const topBusinessesArray = Object.entries(wasteByBusiness)\r\n        .sort((a: any, b: any) => b[1].quantity - a[1].quantity)\r\n        .slice(0, 10)\r\n\r\n      // Get business details\r\n      const topBusinesses = []\r\n      for (const [businessId, data] of topBusinessesArray) {\r\n        const business = await db.business.findUnique({\r\n          where: { id: businessId },\r\n          select: { id: true, name: true, type: true },\r\n        })\r\n        topBusinesses.push({\r\n          businessId,\r\n          business,\r\n          quantity: (data as any).quantity,\r\n          count: (data as any).count,\r\n        })\r\n      }\r\n\r\n      return NextResponse.json({\r\n        totalUsers,\r\n        totalBusinesses,\r\n        totalWaste,\r\n        totalDonations,\r\n        businessesByType,\r\n        topBusinesses,\r\n      })\r\n    }\r\n\r\n    return NextResponse.json({ error: \"Invalid report type\" }, { status: 400 })\r\n  } catch (error) {\r\n    console.error(\"Error generating report:\", error)\r\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 })\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"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","debugId":null}}]
}
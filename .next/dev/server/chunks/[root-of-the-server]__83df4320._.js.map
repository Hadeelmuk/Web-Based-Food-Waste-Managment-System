{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///D:/CS%20Y3/FYP/FWMS/FWMS/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma: PrismaClient | undefined\r\n}\r\n\r\nexport const db =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\r\n  })\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = db\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 71, "column": 0}, "map": {"version":3,"sources":["file:///D:/CS%20Y3/FYP/FWMS/FWMS/app/api/auth/register/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { db } from \"@/lib/db\"\n\nexport const dynamic = \"force-dynamic\"\n\n// POST /api/auth/register\n// Real registration: creates Business + User in SQLite via Prisma\nexport async function POST(req: NextRequest) {\n  try {\n    const body = (await req.json().catch(() => null)) as {\n      email?: string\n      password?: string\n      businessName?: string\n      businessType?: string\n      address?: string\n      contactPerson?: string\n      name?: string\n    } | null\n\n    if (!body) {\n      return NextResponse.json(\n        { error: \"Invalid request body\" },\n        { status: 400 },\n      )\n    }\n\n    if (!body.email || !body.password || !body.businessName || !body.businessType) {\n      return NextResponse.json(\n        { \n          error: \"Missing required fields\", \n          message: \"Email, password, business name, and business type are required\" \n        },\n        { status: 400 },\n      )\n    }\n\n    const email = body.email.toLowerCase()\n\n    // Check if user already exists in the real DB\n    let existingUser\n    try {\n      existingUser = await db.user.findUnique({\n        where: { email },\n      })\n    } catch (dbError) {\n      console.error(\"[POST /api/auth/register] Error checking existing user:\", dbError)\n      return NextResponse.json(\n        { \n          error: \"Database error\", \n          message: \"Failed to check if user exists. Please try again.\" \n        },\n        { status: 500 }\n      )\n    }\n\n    if (existingUser) {\n      return NextResponse.json({ error: \"User with this email already exists\" }, { status: 400 })\n    }\n    \n    // Check if business with this email exists (Business.email is unique)\n    let existingBusiness\n    try {\n      existingBusiness = await db.business.findUnique({\n        where: { email },\n      })\n    } catch (dbError) {\n      console.error(\"[POST /api/auth/register] Error checking existing business:\", dbError)\n      // Continue anyway\n    }\n    \n    // Generate unique business email if user email is already used for a business\n    let businessEmail = email\n    if (existingBusiness) {\n      // Use a different email format for business to avoid conflict\n      const emailParts = email.split('@')\n      businessEmail = `${emailParts[0]}+business@${emailParts[1]}`\n      console.log(`[POST /api/auth/register] Business email conflict, using: ${businessEmail}`)\n      \n      // Check if this alternative email also exists\n      const altBusinessExists = await db.business.findUnique({\n        where: { email: businessEmail },\n      })\n      \n      if (altBusinessExists) {\n        // Use timestamp to make it unique\n        businessEmail = `${emailParts[0]}+business-${Date.now()}@${emailParts[1]}`\n        console.log(`[POST /api/auth/register] Alternative email also exists, using: ${businessEmail}`)\n      }\n    }\n\n    // Map businessType string from the form to our Business.type string\n    const bt = (body.businessType || \"\").toLowerCase()\n    let businessType: string | null = null\n    if (bt === \"cafe\") businessType = \"CAFE\"\n    else if (bt === \"ngo\") businessType = \"NGO\"\n    else if (bt === \"farm\") businessType = \"FARM\"\n    \n    if (!businessType) {\n      return NextResponse.json(\n        { \n          error: \"Invalid business type\", \n          message: \"Business type must be one of: cafe, ngo, or farm\" \n        },\n        { status: 400 },\n      )\n    }\n\n    // Determine high-level app role for routing/localStorage\n    // (these are the same values used elsewhere on the frontend)\n    let appRole: \"admin\" | \"staff\" | \"charity\" | \"farmer\" = \"staff\"\n    if (businessType === \"NGO\") appRole = \"charity\"\n    else if (businessType === \"FARM\") appRole = \"farmer\"\n\n    // Map to DB user role (string field)\n    // We keep three roles at DB level: ADMIN | STAFF | PARTNER\n    let dbRole: string = \"STAFF\"\n    if (appRole === \"charity\" || appRole === \"farmer\") {\n      dbRole = \"PARTNER\"\n    }\n\n    // Create Business + User in a transaction\n    console.log(\"[POST /api/auth/register] Creating business and user...\")\n    console.log(\"[POST /api/auth/register] Business data:\", {\n      name: body.businessName,\n      type: businessType,\n      email: businessEmail,\n    })\n    \n    let result\n    try {\n      result = await db.$transaction(async (tx) => {\n        const business = await tx.business.create({\n          data: {\n            name: body.businessName!,\n            type: businessType,\n            address: body.address || null,\n            contactPerson: body.contactPerson || null,\n            email: businessEmail,\n          },\n        })\n\n        console.log(\"[POST /api/auth/register] Business created:\", business.id)\n\n        const user = await tx.user.create({\n          data: {\n            email,\n            password: body.password!, // plain text to keep compatibility with mock login\n            name: body.name || body.contactPerson || \"New User\",\n            role: dbRole,\n            businessId: business.id,\n          },\n        })\n\n        console.log(\"[POST /api/auth/register] User created:\", user.id)\n\n        return { business, user }\n      })\n    } catch (transactionError) {\n      console.error(\"[POST /api/auth/register] Transaction error:\", transactionError)\n      throw transactionError // Re-throw to be caught by outer catch\n    }\n\n    return NextResponse.json(\n      {\n        message: \"Registration successful\",\n        userId: result.user.id,\n        // Frontend expects lowercase roles: \"admin\" | \"staff\" | \"charity\" | \"farmer\"\n        role: appRole,\n        organizationName: result.business.name,\n        // Use business.id as cafeId equivalent for newer flows\n        cafeId: result.business.id,\n      },\n      { status: 201 },\n    )\n  } catch (error) {\n    console.error(\"[POST /api/auth/register] Error:\", error)\n    console.error(\"[POST /api/auth/register] Error details:\", {\n      message: error instanceof Error ? error.message : String(error),\n      stack: error instanceof Error ? error.stack : undefined,\n      name: error instanceof Error ? error.name : undefined,\n    })\n    \n    // Check for specific database errors\n    let errorMessage = \"Failed to register user\"\n    if (error instanceof Error) {\n      const errorStr = error.message.toLowerCase()\n      \n      if (errorStr.includes(\"unique constraint\") || errorStr.includes(\"unique\")) {\n        errorMessage = \"Email already exists. Please use a different email.\"\n      } else if (errorStr.includes(\"foreign key\") || errorStr.includes(\"constraint\")) {\n        errorMessage = \"Database constraint error. Please check your input.\"\n      } else if (errorStr.includes(\"sqlite\") || errorStr.includes(\"database\")) {\n        errorMessage = \"Database error. Please try again or contact support.\"\n      } else {\n        errorMessage = error.message\n      }\n    }\n    \n    return NextResponse.json(\n      {\n        error: \"Failed to register user\",\n        message: errorMessage,\n        details: process.env.NODE_ENV === \"development\" ? (error instanceof Error ? error.message : String(error)) : undefined,\n      },\n      { status: 500 },\n    )\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}
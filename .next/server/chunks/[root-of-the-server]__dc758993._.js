module.exports=[70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},93449,e=>{"use strict";var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["error"]});e.s(["db",0,r])},91044,e=>{"use strict";var t=e.i(40450),r=e.i(48650),s=e.i(81592),a=e.i(25208),n=e.i(7099),i=e.i(87275),o=e.i(63296),d=e.i(76814),l=e.i(59808),u=e.i(56051),p=e.i(53208),c=e.i(87140),f=e.i(89607),x=e.i(2707),b=e.i(86925),w=e.i(95487),h=e.i(93695);e.i(11756);var g=e.i(21847),E=e.i(74756),m=e.i(96163),R=e.i(1436),y=e.i(93449);async function v(e){try{let t,r=null,s=await (0,m.getServerSession)(R.authOptions);if(s?.user)r={id:s.user.id,role:s.user.role,businessId:s.user.businessId};else{let t=e.headers.get("x-user-id");if(t){let e=await y.db.user.findUnique({where:{id:t},include:{business:!0}});if(!e){let r=await y.db.business.findFirst({where:{type:"CAFE"}});r||(r=await y.db.business.create({data:{name:"Green Café",type:"CAFE",email:`cafe-${t}@example.com`}})),e=await y.db.user.create({data:{id:t,email:`user-${t}@example.com`,password:"temp",role:"STAFF",businessId:r.id,name:"Staff User"},include:{business:!0}})}e&&(r={id:e.id,role:e.role,businessId:e.businessId})}}if(!r)return E.NextResponse.json({error:"Unauthorized"},{status:401});if("STAFF"!==r.role&&"ADMIN"!==r.role)return E.NextResponse.json({error:"Forbidden"},{status:403});if(!r.businessId){let e=await y.db.business.findFirst({where:{type:"CAFE"}});e||(e=await y.db.business.create({data:{name:"Green Café",type:"CAFE",email:`cafe-${r.id}@example.com`}})),await y.db.user.update({where:{id:r.id},data:{businessId:e.id}}),r.businessId=e.id}if(!r.businessId||!r.businessId)return E.NextResponse.json({error:"User business not found"},{status:400});console.log(`[GET /api/staff/waste] Querying database for businessId: ${r.businessId}`);try{t=await y.db.wasteEntry.findMany({where:{businessId:r.businessId},include:{loggedBy:{select:{id:!0,name:!0,email:!0}},business:{select:{id:!0,name:!0,type:!0}}},orderBy:{createdAt:"desc"}}),console.log(`[GET /api/staff/waste] Found ${t.length} entries`)}catch(e){throw console.error("[GET /api/staff/waste] Database error:",e),e}let a={EDIBLE:"edible",COFFEE_GROUNDS:"coffee",ORGANIC:"organic",EXPIRED:"expired",RECYCLABLE:"recyclable",PLATE_WASTE:"plate_waste"},n=t.map(e=>{let t=String(e.wasteType),r=a[t]||t.toLowerCase(),s=String(e.status).toLowerCase(),n=e.availableFor?String(e.availableFor).toLowerCase():null;return{id:e.id,cafeId:e.businessId,type:r,itemName:e.subType||r||"Unknown",quantity:e.quantity,expiryDate:e.expiryDate?e.expiryDate.toISOString().split("T")[0]:"",status:s,assignedTo:n,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString(),notes:e.notes||void 0}}),i={entries:n,total:n.length};return console.log(`[GET /api/staff/waste] Returning ${n.length} entries`),E.NextResponse.json(i,{status:200,headers:{"Content-Type":"application/json"}})}catch(t){console.error("[GET /api/staff/waste] Error:",t),console.error("[GET /api/staff/waste] Error details:",{message:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0});let e={error:"Internal server error",message:t instanceof Error?t.message:String(t)};return console.log("[GET /api/staff/waste] Sending error response:",e),E.NextResponse.json(e,{status:500,headers:{"Content-Type":"application/json"}})}}async function C(e){try{let t=null,r=await (0,m.getServerSession)(R.authOptions);if(r?.user)t={id:r.user.id,role:r.user.role,businessId:r.user.businessId};else{let r=e.headers.get("x-user-id");if(r){let e=await y.db.user.findUnique({where:{id:r},include:{business:!0}});e&&(t={id:e.id,role:e.role,businessId:e.businessId})}}if(!t)return E.NextResponse.json({error:"Unauthorized"},{status:401});if("STAFF"!==t.role&&"ADMIN"!==t.role)return E.NextResponse.json({error:"Only staff and admin can create waste entries"},{status:403});if(!t.businessId){let e=await y.db.business.findFirst({where:{type:"CAFE"}});e||(e=await y.db.business.create({data:{name:"Green Café",type:"CAFE",email:`cafe-${t.id}@example.com`}})),await y.db.user.update({where:{id:t.id},data:{businessId:e.id}}),t.businessId=e.id}let s=await e.json();for(let e of["type","itemName","quantity","expiryDate","assignedTo"])if(!s[e])return E.NextResponse.json({error:`Missing field: ${e}`},{status:400});let a={edible:"EDIBLE",organic:"ORGANIC",coffee:"COFFEE_GROUNDS",expired:"EXPIRED",recyclable:"RECYCLABLE"}[s.type]||"ORGANIC",n={charity:"DONATE",farmer:"FARM"}[s.assignedTo]||"FARM",i=null;i="EDIBLE"===a?"CHARITY":"FARMER";let o=await y.db.wasteEntry.create({data:{wasteType:a,subType:s.itemName,quantity:Number(s.quantity),actionType:n,status:"PENDING",...i&&{availableFor:i},expiryDate:s.expiryDate?new Date(s.expiryDate):null,notes:s.notes||null,loggedById:t.id,businessId:t.businessId},include:{loggedBy:{select:{id:!0,name:!0,email:!0}},business:{select:{id:!0,name:!0,type:!0}}}});return E.NextResponse.json({message:"Waste successfully added",wasteId:o.id,waste:o},{status:201})}catch(e){return console.error("[POST /api/staff/waste] Error:",e),E.NextResponse.json({error:"Internal server error",message:e instanceof Error?e.message:String(e)},{status:500})}}e.s(["GET",()=>v,"POST",()=>C],30501);var I=e.i(30501);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/staff/waste/route",pathname:"/api/staff/waste",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/FWMS/app/api/staff/waste/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:T,workUnitAsyncStorage:N,serverHooks:S}=A;function O(){return(0,s.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:N})}async function F(e,t,s){A.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/staff/waste/route";E=E.replace(/\/index$/,"")||"/";let m=await A.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!m)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:R,params:y,nextConfig:v,parsedUrl:C,isDraftMode:I,prerenderManifest:T,routerServerContext:N,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,resolvedPathname:F,clientReferenceManifest:D,serverActionsManifest:j}=m,P=(0,d.normalizeAppPath)(E),q=!!(T.dynamicRoutes[P]||T.routes[F]),U=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,C,!1):t.end("This page could not be found"),null);if(q&&!I){let e=!!T.routes[F],t=T.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await U();throw new h.NoFallbackError}}let k=null;!q||A.isDev||I||(k="/index"===(k=F)?"/":k);let M=!0===A.isDev||!q,_=q&&!M;j&&D&&(0,i.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:D,serverActionsManifest:j,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:j})});let G=e.method||"GET",H=(0,n.getTracer)(),$=H.getActiveScopeSpan(),L={params:y,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>A.onRequestError(e,t,s,N)},sharedContext:{buildId:R}},B=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),W=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let i=async e=>A.handle(W,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${G} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${G} ${E}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var n,d;let l=async({previousCacheEntry:r})=>{try{if(!o&&S&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let d=L.renderOpts.pendingWaitUntil;d&&s.waitUntil&&(s.waitUntil(d),d=void 0);let l=L.renderOpts.collectedTags;if(!q)return await (0,f.sendResponse)(B,K,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,x.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,s=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:S})},N),t}},u=await A.handleResponse({req:e,nextConfig:v,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,responseGenerator:l,waitUntil:s.waitUntil,isMinimalMode:o});if(!q)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",S?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,x.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&q||p.delete(w.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,b.getCacheControlHeader)(u.cacheControl)),await (0,f.sendResponse)(B,K,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};$?await d($):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${G} ${E}`,kind:n.SpanKind.SERVER,attributes:{"http.method":G,"http.target":e.url}},d))}catch(t){if(t instanceof h.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:S})}),q)throw t;return await (0,f.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>O,"routeModule",()=>A,"serverHooks",()=>S,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>N],91044)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__dc758993._.js.map
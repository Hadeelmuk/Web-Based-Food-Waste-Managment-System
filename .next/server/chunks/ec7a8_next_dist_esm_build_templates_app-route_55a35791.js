module.exports=[39218,e=>{"use strict";var t=e.i(40450),a=e.i(48650),s=e.i(81592),r=e.i(25208),n=e.i(7099),i=e.i(87275),o=e.i(63296),l=e.i(76814),d=e.i(59808),u=e.i(56051),c=e.i(53208),p=e.i(87140),g=e.i(89607),w=e.i(2707),y=e.i(86925),b=e.i(95487),f=e.i(93695);e.i(11756);var R=e.i(21847),E=e.i(74756),T=e.i(96163),h=e.i(1436),m=e.i(93449),S=e.i(85452);let O=S.z.object({date:S.z.string().optional(),wasteType:S.z.enum(["EDIBLE","COFFEE_GROUNDS","ORGANIC","EXPIRED","RECYCLABLE","PLATE_WASTE"]),subType:S.z.string().optional(),quantity:S.z.number().positive(),actionType:S.z.enum(["DONATE","COMPOST","FARM","REUSE","DROPPED"]),destination:S.z.string().optional(),expiryDate:S.z.string().optional(),notes:S.z.string().optional()});async function I(e){let t=await (0,T.getServerSession)(h.authOptions);if(t?.user)return{id:t.user.id,role:t.user.role,businessId:t.user.businessId};let a=e.headers.get("x-user-id");if(a)try{let e=await m.db.user.findUnique({where:{id:a},include:{business:!0}});if(!e){console.log(`[getUserFromRequest] User ${a} not found, creating default user...`);let t=await m.db.business.findFirst({where:{email:`cafe-${a}@example.com`}});t?console.log(`[getUserFromRequest] Found existing business: ${t.id} for user ${a}`):(t=await m.db.business.create({data:{name:"Green Café",type:"CAFE",email:`cafe-${a}@example.com`}}),console.log(`[getUserFromRequest] Created new business: ${t.id} for user ${a}`)),e=await m.db.user.create({data:{id:a,email:`user-${a}@example.com`,password:"$2a$10$dummy",role:"STAFF",businessId:t.id,name:"Staff User"},include:{business:!0}}),console.log(`[getUserFromRequest] Created default user: ${e.id} with businessId: ${t.id}`)}if(e)return{id:e.id,role:e.role,businessId:e.businessId}}catch(e){console.error(`[getUserFromRequest] Database error looking up user ${a}:`,e)}else console.log("[getUserFromRequest] No x-user-id header provided");return null}async function x(e){try{let t,a,s=await I(e);if(!s)return E.NextResponse.json({error:"Unauthorized"},{status:401});if(!s.businessId){let e=await m.db.business.findFirst({where:{email:`cafe-${s.id}@example.com`}});e?console.log(`[GET /api/waste] Found existing business: ${e.id} for user ${s.id}`):(e=await m.db.business.create({data:{name:"Green Café",type:"CAFE",email:`cafe-${s.id}@example.com`}}),console.log(`[GET /api/waste] Created new business: ${e.id} for user ${s.id}`)),await m.db.user.update({where:{id:s.id},data:{businessId:e.id}}),s.businessId=e.id}let{searchParams:r}=new URL(e.url),n=r.get("startDate"),i=r.get("endDate"),o=r.get("wasteType"),l=r.get("actionType"),d=r.get("status"),u="true"===r.get("recent"),c=parseInt(r.get("page")||"1"),p=u?50:parseInt(r.get("limit")||"50"),g=(c-1)*p,w={};if("ADMIN"!==s.role)w.businessId=s.businessId;else{let e=r.get("businessId");e&&(w.businessId=e)}(n||i)&&(w.date={},n&&(w.date.gte=new Date(n)),i&&(w.date.lte=new Date(i))),o&&"all"!==o&&(w.wasteType=o),l&&"all"!==l&&(w.actionType=l),d&&"all"!==d&&(w.status=d),console.log("[GET /api/waste] Querying with where clause:",JSON.stringify(w,null,2));try{[t,a]=await Promise.all([m.db.wasteEntry.findMany({where:w,include:{loggedBy:{select:{id:!0,name:!0,email:!0}},business:{select:{id:!0,name:!0,type:!0}}},orderBy:u?{createdAt:"desc"}:{date:"desc"},skip:g,take:p}),m.db.wasteEntry.count({where:w})]),console.log(`[GET /api/waste] Found ${t.length} entries (total: ${a})`)}catch(t){console.error("[GET /api/waste] Database error:",t);let e=t instanceof Error?t.message:String(t);return E.NextResponse.json({error:"Database error",message:e,details:void 0},{status:500})}let y={EDIBLE:"edible",COFFEE_GROUNDS:"coffee",ORGANIC:"organic",EXPIRED:"expired",RECYCLABLE:"recyclable",PLATE_WASTE:"plate_waste"},b=t.map(e=>{let t=String(e.wasteType),a=y[t]||t.toLowerCase(),s=String(e.status).toLowerCase(),r=e.availableFor?String(e.availableFor).toLowerCase():null;return{id:e.id,cafeId:e.businessId,type:a,itemName:e.subType||a||"Unknown",quantity:e.quantity,expiryDate:e.expiryDate?e.expiryDate.toISOString().split("T")[0]:"",status:s,assignedTo:r,actionType:e.actionType,wasteType:e.wasteType,subType:e.subType,destination:e.destination,date:e.date,loggedByName:e.loggedBy?.name||"Staff",createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString(),notes:e.notes||void 0}});if(u)return E.NextResponse.json({entries:b,total:b.length});return E.NextResponse.json({entries:b,pagination:{page:c,limit:p,total:a,totalPages:Math.ceil(a/p)}})}catch(t){console.error("[GET /api/waste] Error fetching waste entries:",t);let e=t instanceof Error?t.message:String(t);return E.NextResponse.json({error:"Failed to fetch waste entries",message:e,entries:[],total:0},{status:500})}}async function P(e){try{let t,a=await I(e);if(!a)return console.error("[POST /api/waste] Unauthorized - no user found"),E.NextResponse.json({error:"Unauthorized - please log in again"},{status:401});if(console.log("[POST /api/waste] User authenticated:",{id:a.id,role:a.role,businessId:a.businessId}),"STAFF"!==a.role&&"ADMIN"!==a.role)return E.NextResponse.json({error:"Only staff members can log waste"},{status:403});if(!a.businessId){let e=await m.db.business.findFirst({where:{email:`cafe-${a.id}@example.com`}});e?console.log(`[POST /api/waste] Found existing business: ${e.id} for user ${a.id}`):(e=await m.db.business.create({data:{name:"Green Café",type:"CAFE",email:`cafe-${a.id}@example.com`}}),console.log(`[POST /api/waste] Created new business: ${e.id} for user ${a.id}`)),await m.db.user.update({where:{id:a.id},data:{businessId:e.id}}),a.businessId=e.id}let s=await e.json(),r=O.parse(s),n="PENDING",i=null;if("DROPPED"===r.actionType?n="DROPPED":(i="EDIBLE"===r.wasteType?"CHARITY":"FARMER",n="PENDING"),!a.businessId)return console.error("[POST /api/waste] ERROR: user.businessId is null"),E.NextResponse.json({error:"Database error",message:"Unable to associate waste entry with a business. Please try again."},{status:500});if(!a.id)return console.error("[POST /api/waste] ERROR: user.id is null"),E.NextResponse.json({error:"Database error",message:"User ID is missing. Please log in again."},{status:500});try{if(!await m.db.user.findUnique({where:{id:a.id}}))return console.error("[POST /api/waste] ERROR: User does not exist in database:",a.id),E.NextResponse.json({error:"Database error",message:"User not found. Please log in again."},{status:500})}catch(e){console.error("[POST /api/waste] ERROR checking user:",e)}try{if(!await m.db.business.findUnique({where:{id:a.businessId}}))return console.error("[POST /api/waste] ERROR: Business does not exist in database:",a.businessId),E.NextResponse.json({error:"Database error",message:"Business not found. Please contact support."},{status:500})}catch(e){console.error("[POST /api/waste] ERROR checking business:",e)}console.log("[POST /api/waste] BEFORE db.wasteEntry.create() - Data:",{wasteType:r.wasteType,quantity:r.quantity,actionType:r.actionType,status:n,availableFor:i,businessId:a.businessId,loggedById:a.id});try{let e=new Date;if(r.date)try{e=new Date(r.date),isNaN(e.getTime())&&(e=new Date)}catch(t){e=new Date}let s={date:e,wasteType:r.wasteType,quantity:r.quantity,actionType:r.actionType,status:n,loggedById:a.id,businessId:a.businessId};if(r.subType&&(s.subType=r.subType),r.destination&&(s.destination=r.destination),r.expiryDate)try{let e=new Date(r.expiryDate);isNaN(e.getTime())||(s.expiryDate=e)}catch(e){console.warn("[POST /api/waste] Invalid expiry date, skipping:",r.expiryDate)}r.notes&&(s.notes=r.notes),i&&(s.availableFor=i),console.log("[POST /api/waste] Creating with data:",JSON.stringify(s,null,2)),t=await m.db.wasteEntry.create({data:s,include:{loggedBy:{select:{id:!0,name:!0,email:!0}},business:{select:{id:!0,name:!0,type:!0}}}}),console.log("[POST /api/waste] AFTER db.wasteEntry.create() - Success! Entry ID:",t.id),console.log("[POST /api/waste] Created entry details:",{id:t.id,wasteType:t.wasteType,subType:t.subType,quantity:t.quantity,actionType:t.actionType,status:t.status,availableFor:t.availableFor,businessId:t.businessId});try{let e=0;"DONATE"===r.actionType?e=Math.floor(r.quantity):"COMPOST"===r.actionType||"FARM"===r.actionType?e=Math.floor(.5*r.quantity):"REUSE"===r.actionType&&(e=Math.floor(.8*r.quantity)),e>0&&(await m.db.pointsHistory.create({data:{userId:a.id,wasteEntryId:t.id,points:e,reason:`Logged ${r.quantity} kg of ${r.wasteType.toLowerCase()} - ${r.actionType.toLowerCase()}`}}),console.log("[POST /api/waste] Points awarded:",e))}catch(e){console.error("[POST /api/waste] Failed to create points history (non-critical):",e)}return E.NextResponse.json(t,{status:201})}catch(a){console.error("[POST /api/waste] Database error during create:",a),console.error("[POST /api/waste] Error details:",{message:a instanceof Error?a.message:String(a),stack:a instanceof Error?a.stack:void 0,name:a instanceof Error?a.name:void 0});let e=a instanceof Error?a.message:String(a),t="Failed to create waste entry";return e.includes("Foreign key constraint")||e.includes("foreign key")?t="Invalid user or business. Please log in again.":e.includes("NOT NULL constraint")||e.includes("null")?t="Missing required information. Please fill in all fields.":(e.includes("SQLite")||e.includes("database"))&&(t="Database error. Please try again."),E.NextResponse.json({error:"Database error",message:t,details:void 0},{status:500})}}catch(t){if(t instanceof S.z.ZodError)return E.NextResponse.json({error:"Invalid input data",details:t.errors},{status:400});console.error("[POST /api/waste] Error creating waste entry:",t);let e=t instanceof Error?t.message:String(t);return E.NextResponse.json({error:"Failed to create waste entry",message:e,details:void 0},{status:500})}}e.s(["GET",()=>x,"POST",()=>P],8478);var C=e.i(8478);let v=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/waste/route",pathname:"/api/waste",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/FWMS/app/api/waste/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:D,workUnitAsyncStorage:N,serverHooks:A}=v;function F(){return(0,s.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:N})}async function U(e,t,s){v.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/waste/route";E=E.replace(/\/index$/,"")||"/";let T=await v.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!T)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:h,params:m,nextConfig:S,parsedUrl:O,isDraftMode:I,prerenderManifest:x,routerServerContext:P,isOnDemandRevalidate:C,revalidateOnlyGenerated:D,resolvedPathname:N,clientReferenceManifest:A,serverActionsManifest:F}=T,U=(0,l.normalizeAppPath)(E),$=!!(x.dynamicRoutes[U]||x.routes[N]),q=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,O,!1):t.end("This page could not be found"),null);if($&&!I){let e=!!x.routes[N],t=x.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await q();throw new f.NoFallbackError}}let M=null;!$||v.isDev||I||(M="/index"===(M=N)?"/":M);let k=!0===v.isDev||!$,_=$&&!k;F&&A&&(0,i.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:A,serverActionsManifest:F,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:F})});let j=e.method||"GET",L=(0,n.getTracer)(),B=L.getActiveScopeSpan(),G={params:m,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,s)=>v.onRequestError(e,t,s,P)},sharedContext:{buildId:h}},H=new d.NodeNextRequest(e),z=new d.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(H,(0,u.signalFromNodeResponse)(t));try{let i=async e=>v.handle(K,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=L.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${j} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${E}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&C&&D&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(r);e.fetchMetrics=G.renderOpts.fetchMetrics;let l=G.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let d=G.renderOpts.collectedTags;if(!$)return await (0,g.sendResponse)(H,z,n,G.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,w.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[b.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=b.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,s=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=b.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==a?void 0:a.isStale)&&await v.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:C})},P),t}},u=await v.handleResponse({req:e,nextConfig:S,cacheKey:M,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:D,responseGenerator:d,waitUntil:s.waitUntil,isMinimalMode:o});if(!$)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,w.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&$||c.delete(b.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,y.getCacheControlHeader)(u.cacheControl)),await (0,g.sendResponse)(H,z,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};B?await l(B):await L.withPropagatedContext(e.headers,()=>L.trace(c.BaseServerSpan.handleRequest,{spanName:`${j} ${E}`,kind:n.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await v.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:C})}),$)throw t;return await (0,g.sendResponse)(H,z,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>F,"routeModule",()=>v,"serverHooks",()=>A,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>N],39218)}];

//# sourceMappingURL=ec7a8_next_dist_esm_build_templates_app-route_55a35791.js.map